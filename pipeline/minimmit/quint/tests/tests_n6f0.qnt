module tests {
    import types.* from "../types"
    import defs.* from "../defs"
    import option.* from "../option"
    import replica(
        N = 6,
        F = 1,
        CORRECT = Set("n0", "n1", "n2", "n3", "n4", "n5"),
        FAULTY = Set(),
        VIEWS = 0.to(5),
        VALID_BLOCKS = Set("val_b0", "val_b1", "val_b2"),
        INVALID_BLOCKS = Set("inv_b3")
    ).* from "../replica"

    run asuumptionsValidTest = all {
        Q == 5,
        L == 3,
        assumptions_valid
    }

    // Simple init test
    run initTest = {
        initWithLeader(Map(0 -> "n0", 1 -> "n0", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))
            .then(all {
                assert(replica_state.get("n0").view == 0),
                assert(replica_state.get("n1").view == 0),
                assert(replica_state.get("n2").view == 0),
                assert(replica_state.get("n3").view == 0),
                assert(replica_state.get("n4").view == 0),
                assert(replica_state.get("n5").view == 0),
                assert(leader.get(1) == "n0"),
                unchanged_all
            })}


    // Minimal test without init
    run minimalProposalTest = {
        // Manual state setup
        initWithLeader(Map(0 -> "n0", 1 -> "n0", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))
        .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW))
        .then(all {
            assert(sent_proposal.size() == 1),
            unchanged_all
        })
    }

    // Three nodes happy path - based on reference test structure
    run happyPathTest = {
        val proposal = {
            block: "val_b0",
            view: 0,
            view_parent: GENESIS_VIEW,
            block_parent: GENESIS_BLOCK,
            sig: sig_of("n0")
        }

        initWithLeader(Map(0 -> "n0", 1 -> "n0", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))
            // Leader n0 proposes in view 0
            .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW))
            .then( all {
                assert(replica_state.get("n0").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .expect(all_invariants)
            // All replicas process the proposal and vote for it (n0 already did!)
            .then(on_proposal("n1", proposal))
            .then( all {
                assert(replica_state.get("n1").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .then(on_proposal("n2", proposal))
            .then( all {
                assert(replica_state.get("n2").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .then(on_proposal("n3", proposal))
            .then( all {
                assert(replica_state.get("n3").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .then(on_proposal("n4", proposal))
            .then( all {
                assert(replica_state.get("n4").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .then(on_proposal("n5", proposal))
            .then( all {
                assert(replica_state.get("n5").notarized.get(0)=="val_b0"),
                unchanged_all
            })
            .expect(all_invariants)

            // All replicas collect votes and notarize the block
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n5"))

            .expect(select_votes(0, NotarizeKind, store_vote.get("n0")).size()==6)
            .expect(select_votes(0, NotarizeKind, store_vote.get("n1")).size()==6)
            .expect(select_votes(0, NotarizeKind, store_vote.get("n2")).size()==6)
            .expect(select_votes(0, NotarizeKind, store_vote.get("n3")).size()==6)
            .expect(select_votes(0, NotarizeKind, store_vote.get("n4")).size()==6)
            .expect(select_votes(0, NotarizeKind, store_vote.get("n5")).size()==6)

            .expect(is_view_finalized(0, store_vote.get("n0"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n0"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n1"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n2"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n3"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n4"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n5"), "val_b0"))

            .expect(store_certificate.get("n0").size() == 2)
            .expect(store_certificate.get("n1").size() == 2)
            .expect(store_certificate.get("n2").size() == 2)
            .expect(store_certificate.get("n3").size() == 2)
            .expect(store_certificate.get("n4").size() == 2)
            .expect(store_certificate.get("n5").size() == 2)

            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n1")))
            .expect(is_view_notarized(0, store_certificate.get("n2")))
            .expect(is_view_notarized(0, store_certificate.get("n3")))
            .expect(is_view_notarized(0, store_certificate.get("n4")))
            .expect(is_view_notarized(0, store_certificate.get("n5")))
            .expect(all_invariants)

            .then(all {
                assert(replica_state.get("n0").last_finalized == 0),
                assert(replica_state.get("n1").last_finalized == 0),
                assert(replica_state.get("n2").last_finalized == 0),
                assert(replica_state.get("n3").last_finalized == 0),
                assert(replica_state.get("n4").last_finalized == 0),
                assert(replica_state.get("n5").last_finalized == 0),
                unchanged_all,
            })

            .then(all {
                assert(replica_state.get("n0").view == 1),
                assert(replica_state.get("n1").view == 1),
                assert(replica_state.get("n2").view == 1),
                assert(replica_state.get("n3").view == 1),
                assert(replica_state.get("n4").view == 1),
                assert(replica_state.get("n5").view == 1),
                unchanged_all,
            })

            .then(all {
                assert(ghost_committed_blocks.get("n0") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n1") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n2") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n3") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n4") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n5") == ["val_b0"]),
                unchanged_all,
            })

    }

    // Two blocks happy path test - commits blocks in views 1 and 2
    run twoBlocksTest = {
        val proposal1 = {
            block: "val_b0",
            view: 0,
            view_parent: GENESIS_VIEW,
            block_parent: GENESIS_BLOCK,
            sig: sig_of("n0")
        }

        val proposal2 = {
            block: "val_b1",
            view: 1,
            view_parent: 0,
            block_parent: "val_b0",
            sig: sig_of("n1")
        }

        initWithLeader(Map(0 -> "n0", 1 -> "n1", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))

            // === FIRST BLOCK (VIEW 1) ===
            // Leader n0 proposes in view 1
            .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW))
            .expect(all_invariants)

            // All replicas process the proposal and vote for it (n0 did it already)
            .then(on_proposal("n1", proposal1))
            .then(on_proposal("n2", proposal1))
            .then(on_proposal("n3", proposal1))
            .then(on_proposal("n4", proposal1))
            .then(on_proposal("n5", proposal1))
            .expect(all_invariants)

            // All replicas collect votes for block 1
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n5"))

            // Verify first block is finalized and committed
            .expect(is_view_finalized(0, store_vote.get("n0"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n1"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n2"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n3"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n4"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n5"), "val_b0"))

            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n1")))
            .expect(is_view_notarized(0, store_certificate.get("n2")))
            .expect(is_view_notarized(0, store_certificate.get("n3")))
            .expect(is_view_notarized(0, store_certificate.get("n4")))
            .expect(is_view_notarized(0, store_certificate.get("n5")))

            // Check first block is committed and replicas advance to view 1
            .then(all {
                assert(replica_state.get("n0").last_finalized == 0),
                assert(replica_state.get("n1").last_finalized == 0),
                assert(replica_state.get("n2").last_finalized == 0),
                assert(replica_state.get("n3").last_finalized == 0),
                assert(replica_state.get("n4").last_finalized == 0),
                assert(replica_state.get("n5").last_finalized == 0),

                assert(replica_state.get("n0").view == 1),
                assert(replica_state.get("n1").view == 1),
                assert(replica_state.get("n2").view == 1),
                assert(replica_state.get("n3").view == 1),
                assert(replica_state.get("n4").view == 1),
                assert(replica_state.get("n5").view == 1),

                assert(ghost_committed_blocks.get("n0") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n1") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n2") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n3") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n4") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n5") == ["val_b0"]),

                unchanged_all,
            })

            // === SECOND BLOCK (VIEW 1) ===
            // Leader n1 proposes in view 1
            .then(proposer_step("n1", "val_b1", "val_b0", 0))
            .expect(all_invariants)

            // All replicas process the second proposal and vote for it (n1 already did!)
            .then(on_proposal("n0", proposal2))
            //.then(on_proposal("n1", proposal2))
            .then(on_proposal("n2", proposal2))
            .then(on_proposal("n3", proposal2))
            .then(on_proposal("n4", proposal2))
            .then(on_proposal("n5", proposal2))
            .expect(all_invariants)

            // All replicas collect votes for block 2
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n5"))

            // Verify second block is finalized and committed
            .expect(is_view_finalized(1, store_vote.get("n0"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n1"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n2"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n3"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n4"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n5"), "val_b1"))

            .expect(is_view_notarized(1, store_certificate.get("n0")))
            .expect(is_view_notarized(1, store_certificate.get("n1")))
            .expect(is_view_notarized(1, store_certificate.get("n2")))
            .expect(is_view_notarized(1, store_certificate.get("n3")))
            .expect(is_view_notarized(1, store_certificate.get("n4")))
            .expect(is_view_notarized(1, store_certificate.get("n5")))

            // Check both blocks are committed and replicas advance to view 3
            .then(all {
                assert(replica_state.get("n0").last_finalized == 1),
                assert(replica_state.get("n1").last_finalized == 1),
                assert(replica_state.get("n2").last_finalized == 1),
                assert(replica_state.get("n3").last_finalized == 1),
                assert(replica_state.get("n4").last_finalized == 1),
                assert(replica_state.get("n5").last_finalized == 1),

                assert(replica_state.get("n0").view == 2),
                assert(replica_state.get("n1").view == 2),
                assert(replica_state.get("n2").view == 2),
                assert(replica_state.get("n3").view == 2),
                assert(replica_state.get("n4").view == 2),
                assert(replica_state.get("n5").view == 2),

                // Both blocks should be in the committed chain
                assert(ghost_committed_blocks.get("n0") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n1") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n2") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n3") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n4") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n5") == ["val_b0", "val_b1"]),

                unchanged_all,
            })
            .expect(all_invariants)
    }

    // Two blocks happy path test - but notarization and finalizations are processed in different views
    run twoBlocksDifferentViewsTest = {
        val proposal1 = {
            block: "val_b0",
            view: 0,
            view_parent: GENESIS_VIEW,
            block_parent: GENESIS_BLOCK,
            sig: sig_of("n0")
        }

        val proposal2 = {
            block: "val_b1",
            view: 1,
            view_parent: 0,
            block_parent: "val_b0",
            sig: sig_of("n1")
        }

        initWithLeader(Map(0 -> "n0", 1 -> "n1", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))

            // === FIRST BLOCK (VIEW 1) ===
            // Leader n0 proposes in view 1
            .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW))
            .expect(all_invariants)

            // All replicas process the proposal and vote for it (n0 did it already)
            .then(on_proposal("n1", proposal1))
            .then(on_proposal("n2", proposal1))
            .then(on_proposal("n3", proposal1))
            .then(on_proposal("n4", proposal1))
            .then(on_proposal("n5", proposal1))
            .expect(all_invariants)

            // All replicas collect semiquorum for block 1
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n2"))

            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n3"))

            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n4"))

            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n5"))

            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))

            .expect(not(is_view_finalized(0, store_vote.get("n0"), "val_b0")))
            .expect(not(is_view_finalized(0, store_vote.get("n1"), "val_b0")))
            .expect(not(is_view_finalized(0, store_vote.get("n2"), "val_b0")))
            .expect(not(is_view_finalized(0, store_vote.get("n3"), "val_b0")))
            .expect(not(is_view_finalized(0, store_vote.get("n4"), "val_b0")))
            .expect(not(is_view_finalized(0, store_vote.get("n5"), "val_b0")))

            .then(all {
                assert(replica_state.get("n0").last_finalized == GENESIS_VIEW),
                assert(replica_state.get("n1").last_finalized == GENESIS_VIEW),
                assert(replica_state.get("n2").last_finalized == GENESIS_VIEW),
                assert(replica_state.get("n3").last_finalized == GENESIS_VIEW),
                assert(replica_state.get("n4").last_finalized == GENESIS_VIEW),
                assert(replica_state.get("n5").last_finalized == GENESIS_VIEW),

                assert(replica_state.get("n0").view == 1),
                assert(replica_state.get("n1").view == 1),
                assert(replica_state.get("n2").view == 1),
                assert(replica_state.get("n3").view == 1),
                assert(replica_state.get("n4").view == 1),
                assert(replica_state.get("n5").view == 1),

                assert(ghost_committed_blocks.get("n0") == []),
                assert(ghost_committed_blocks.get("n1") == []),
                assert(ghost_committed_blocks.get("n2") == []),
                assert(ghost_committed_blocks.get("n3") == []),
                assert(ghost_committed_blocks.get("n4") == []),
                assert(ghost_committed_blocks.get("n5") == []),

                unchanged_all,
            })

            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n3"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n2"))

            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n4"))
            .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n3", "val_b0", 0, "n5"))

            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n1"))
            .then(replica_receives_notarize_vote("n4", "val_b0", 0, "n2"))

            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n0"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n2"))
            .then(replica_receives_notarize_vote("n5", "val_b0", 0, "n3"))

            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))
            .expect(is_view_notarized(0, store_certificate.get("n0")))

            // Verify first block is finalized and committed
            .expect(is_view_finalized(0, store_vote.get("n0"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n1"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n2"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n3"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n4"), "val_b0"))
            .expect(is_view_finalized(0, store_vote.get("n5"), "val_b0"))

            // Check first block is committed and replicas advance to view 2
            .then(all {
                assert(replica_state.get("n0").last_finalized == 0),
                assert(replica_state.get("n1").last_finalized == 0),
                assert(replica_state.get("n2").last_finalized == 0),
                assert(replica_state.get("n3").last_finalized == 0),
                assert(replica_state.get("n4").last_finalized == 0),
                assert(replica_state.get("n5").last_finalized == 0),

                assert(replica_state.get("n0").view == 1),
                assert(replica_state.get("n1").view == 1),
                assert(replica_state.get("n2").view == 1),
                assert(replica_state.get("n3").view == 1),
                assert(replica_state.get("n4").view == 1),
                assert(replica_state.get("n5").view == 1),

                assert(ghost_committed_blocks.get("n0") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n1") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n2") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n3") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n4") == ["val_b0"]),
                assert(ghost_committed_blocks.get("n5") == ["val_b0"]),

                unchanged_all,
            })

            // === SECOND BLOCK (VIEW 1) ===
            // Leader n1 proposes in view 1
            .then(proposer_step("n1", "val_b1", "val_b0", 0))
            .expect(all_invariants)

            // All replicas process the second proposal and vote for it (n1 already did!)
            .then(on_proposal("n0", proposal2))
            .then(on_proposal("n2", proposal2))
            .then(on_proposal("n3", proposal2))
            .then(on_proposal("n4", proposal2))
            .then(on_proposal("n5", proposal2))
            .expect(all_invariants)

            // All replicas collect votes for block 2
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n0", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n1", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n2", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n3", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n4", "val_b1", 1, "n5"))

            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n0"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n1"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n2"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n3"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n4"))
            .then(replica_receives_notarize_vote("n5", "val_b1", 1, "n5"))

            // Verify second block is finalized and committed
            .expect(is_view_finalized(1, store_vote.get("n0"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n1"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n2"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n3"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n4"), "val_b1"))
            .expect(is_view_finalized(1, store_vote.get("n5"), "val_b1"))

            .expect(is_view_notarized(1, store_certificate.get("n0")))
            .expect(is_view_notarized(1, store_certificate.get("n1")))
            .expect(is_view_notarized(1, store_certificate.get("n2")))
            .expect(is_view_notarized(1, store_certificate.get("n3")))
            .expect(is_view_notarized(1, store_certificate.get("n4")))
            .expect(is_view_notarized(1, store_certificate.get("n5")))


            // Check both blocks are committed and replicas advance to view 3
            .then(all {
                assert(replica_state.get("n0").last_finalized == 1),
                assert(replica_state.get("n1").last_finalized == 1),
                assert(replica_state.get("n2").last_finalized == 1),
                assert(replica_state.get("n3").last_finalized == 1),
                assert(replica_state.get("n4").last_finalized == 1),
                assert(replica_state.get("n5").last_finalized == 1),

                assert(replica_state.get("n0").view == 2),
                assert(replica_state.get("n1").view == 2),
                assert(replica_state.get("n2").view == 2),
                assert(replica_state.get("n3").view == 2),
                assert(replica_state.get("n4").view == 2),
                assert(replica_state.get("n5").view == 2),

                // Both blocks should be in the committed chain
                assert(ghost_committed_blocks.get("n0") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n1") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n2") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n3") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n4") == ["val_b0", "val_b1"]),
                assert(ghost_committed_blocks.get("n5") == ["val_b0", "val_b1"]),

                unchanged_all,
            })

            .expect(all_invariants)
    }

    run timeoutTest = {
        // ----- first block (view 1) -----
        val proposal1 = {
            block: "val_b0",
            block_parent: GENESIS_BLOCK,
            view: 0,
            view_parent: GENESIS_VIEW,
            sig: sig_of("n0")
        }

        initWithLeader(Map(0 -> "n0", 1 -> "n5", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n4"))
        // === view 0 ===
        .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW)) // leader n0 proposes, view 0
        .expect(all_invariants)
        // n0 has sent notarize vote for its proposal in proposer_step, but all other replicas do not see it
        .then(on_timer_expired("n1"))
        .then(on_timer_expired("n2"))
        .then(on_timer_expired("n3"))
        .then(on_timer_expired("n4"))
        .then(on_timer_expired("n5"))
        .expect(all_invariants)

        .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n0"))

        .then(replica_receives_nullify_vote("n1", 0, "n1"))
        .then(replica_receives_nullify_vote("n1", 0, "n2"))
        .then(replica_receives_nullify_vote("n1", 0, "n3"))
        .then(replica_receives_nullify_vote("n1", 0, "n4"))
        .then(replica_receives_nullify_vote("n1", 0, "n5"))

        .then(replica_receives_nullify_vote("n2", 0, "n1"))
        .then(replica_receives_nullify_vote("n2", 0, "n2"))
        .then(replica_receives_nullify_vote("n2", 0, "n3"))
        .then(replica_receives_nullify_vote("n2", 0, "n4"))
        .then(replica_receives_nullify_vote("n2", 0, "n5"))

        .then(replica_receives_nullify_vote("n3", 0, "n1"))
        .then(replica_receives_nullify_vote("n3", 0, "n2"))
        .then(replica_receives_nullify_vote("n3", 0, "n3"))
        .then(replica_receives_nullify_vote("n3", 0, "n4"))
        .then(replica_receives_nullify_vote("n3", 0, "n5"))

        .then(replica_receives_nullify_vote("n4", 0, "n1"))
        .then(replica_receives_nullify_vote("n4", 0, "n2"))
        .then(replica_receives_nullify_vote("n4", 0, "n3"))
        .then(replica_receives_nullify_vote("n4", 0, "n4"))
        .then(replica_receives_nullify_vote("n4", 0, "n5"))

        .then(replica_receives_nullify_vote("n5", 0, "n1"))
        .then(replica_receives_nullify_vote("n5", 0, "n2"))
        .then(replica_receives_nullify_vote("n5", 0, "n3"))
        .then(replica_receives_nullify_vote("n5", 0, "n4"))
        .then(replica_receives_nullify_vote("n5", 0, "n5"))

        .then(all {
            assert(replica_state.get("n0").view == 0),
            assert(replica_state.get("n1").view == 1),
            assert(replica_state.get("n2").view == 1),
            assert(replica_state.get("n3").view == 1),
            assert(replica_state.get("n4").view == 1),
            assert(replica_state.get("n5").view == 1),
            unchanged_all,
        })
        .expect(all_invariants)
        .then(all {
            assert(ghost_committed_blocks.get("n0") == []),
            assert(ghost_committed_blocks.get("n1") == []),
            assert(ghost_committed_blocks.get("n2") == []),
            assert(ghost_committed_blocks.get("n3") == []),
            assert(ghost_committed_blocks.get("n4") == []),
            assert(ghost_committed_blocks.get("n5") == []),
            unchanged_all,
        })
    }

    run contradictionTest = {
        pure val proposal0 = {
            block: "val_b0",
            view: 0,
            view_parent: GENESIS_VIEW,
            block_parent: GENESIS_BLOCK,
            sig: sig_of("n0")
        }

        initWithLeader(Map(0 -> "n0", 1 -> "n5", 2 -> "n1", 3 -> "n2", 4 -> "n3", 5 -> "n1"))
        // === view 0 ===
        .then(proposer_step("n0", "val_b0", GENESIS_BLOCK, GENESIS_VIEW))
        .then(on_proposal("n1", proposal0))
        .then(on_proposal("n2", proposal0))

        .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n0"))
        .then(replica_receives_notarize_vote("n0", "val_b0", 0, "n1"))

        .then(replica_receives_notarize_vote("n1", "val_b0", 0, "n0"))

        .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n0"))
        .then(replica_receives_notarize_vote("n2", "val_b0", 0, "n1"))

        .then(on_timer_expired("n3"))
        .then(on_timer_expired("n4"))
        .then(on_timer_expired("n5"))

        .then(all {
            assert(replica_state.get("n0").view == 0),
            assert(replica_state.get("n1").view == 0),
            assert(replica_state.get("n2").view == 0),
            assert(replica_state.get("n3").view == 0),
            assert(replica_state.get("n4").view == 0),
            assert(replica_state.get("n5").view == 0),
            unchanged_all,
        })

        .expect(all_invariants)

        .then(replica_receives_nullify_vote("n0", 0, "n3"))
        .then(replica_receives_nullify_vote("n0", 0, "n4"))

        .then(all {
            assert(store_vote.get("n0").filter(v=>v.view==0 and v.kind==NotarizeKind and v.block_hash != "val_b0").size() == 0),
            assert(store_vote.get("n0").filter(v=>v.view==0 and v.kind==NullifyKind).size() == 2),
            assert(replica_state.get("n0").nullified == false),
            assert(replica_state.get("n0").notarized.get(0) == "val_b0"),
            assert(is_contradicted(replica_state.get("n0"), 0, store_vote.get("n0")) == false),
            unchanged_all,
        })

        // no contradiction, no nullification will be sent.

        .then(all {
            assert(store_vote.get("n0").filter(v=>v.view==0).size() == 4),
            assert(replica_state.get("n0").nullified == false),
            unchanged_all,
        })

        // n1 gets vote for block from n0 and 3 nullify votes from n3-n5
        .then(replica_receives_nullify_vote("n1", 0, "n3"))
        .then(all {
            assert(store_vote.get("n1").filter(v=>v.view==0).size() == 2),
            assert(replica_state.get("n1").nullified == false),
            unchanged_all,
        })
        .then(replica_receives_nullify_vote("n1", 0, "n4"))
        .then(replica_receives_nullify_vote("n1", 0, "n5"))
        .then(all {
            assert(store_vote.get("n1").filter(v=>v.view==0 and v.kind==NullifyKind).size() == 3),
            assert(store_vote.get("n1").filter(v=>v.view==0).size() == 4),
            assert(replica_state.get("n1").view == 1),
            unchanged_all,
        })


    }

    action replica_receives_notarize_vote(id: ReplicaId, block_hash: BlockHash, view: ViewNumber, src: ReplicaId): bool =
        on_vote_notarize(id, view, block_hash,  Set(notarize(view, src, block_hash)))

    action replica_receives_nullify_vote(id: ReplicaId, view: ViewNumber, src: str): bool =
        on_vote_nullify(id, view, Set(nullify(view, src)))

    action unchanged_all = all {
        sent_proposal' = sent_proposal,
        sent_vote' = sent_vote,
        sent_certificate' = sent_certificate,
        store_vote' = store_vote,
        store_certificate' = store_certificate,
        ghost_proposal' = ghost_proposal,
        ghost_committed_blocks' = ghost_committed_blocks,
        leader' = leader,
        replica_state' = replica_state,
    }

}