// -*- mode: Bluespec; -*-

// Scenario tests for n=7, f=2 with 1 Byzantine dealer (p5) and 1 Byzantine player (p6)
module scenarios_n7 {
    import types.* from "../types"
    import defs.* from "../defs"
    import dkg(
        N = 7,
        F = 2,
        DEALERS = Set("p0", "p1", "p2", "p3", "p4", "p5", "p6"),
        PLAYERS = Set("p0", "p1", "p2", "p3", "p4", "p5", "p6"),
        CORRECT_DEALERS = Set("p0", "p1", "p2", "p3", "p4", "p6"),
        BYZANTINE_DEALERS = Set("p5"),
        CORRECT_PLAYERS = Set("p0", "p1", "p2", "p3", "p4", "p5"),
        BYZANTINE_PLAYERS = Set("p6"),
        EVAL_POINTS = Map("p0" -> 1, "p1" -> 2, "p2" -> 3, "p3" -> 4, "p4" -> 5, "p5" -> 6, "p6" -> 7),
        DEGREE = 4,
        POLYNOMIALS = Set(
            List(1, 2, 3, 4, 5),
            List(6, 7, 8, 9, 10),
            List(11, 12, 13, 14, 15)
        ),
        BYZANTINE_COMMITMENTS = Set(List(1, 1, 1, 1, 1), List(0, 0, 0, 0, 0)),
        BYZANTINE_SHARES = Set(0, 1, 999),
    ).* from "../dkg"

    // Test helpers
    action player_receives_share(player: ParticipantId, dealer: ParticipantId, poly: Polynomial): bool =
        player_receive_dealer_msg(player, dealer,
            { commitment: poly },
            { share: eval_poly(poly, EVAL_POINTS.get(player)) })

    action dealer_receives_ack(dealer: ParticipantId, player: ParticipantId): bool =
        dealer_receive_ack(dealer, { player: player, dealer: dealer })

    action dealer_finalizes(dealer: ParticipantId): bool =
        dealer_timer_expired(dealer)

    // Happy path: correct dealers complete, Byzantine player p6 doesn't ACK
    run happyPathN7Test = {
        val poly0 = List(1, 2, 3, 4, 5)
        val poly1 = List(6, 7, 8, 9, 10)
        val poly2 = List(11, 12, 13, 14, 15)
        val poly3 = List(1, 2, 3, 4, 5)
        val poly4 = List(6, 7, 8, 9, 10)
        val poly6 = List(11, 12, 13, 14, 15)

        init
            .then(dealer_start("p0", poly0))
            .then(dealer_start("p1", poly1))
            .then(dealer_start("p2", poly2))
            .then(dealer_start("p3", poly3))
            .then(dealer_start("p4", poly4))
            .then(dealer_start("p6", poly6))
            .expect(CORRECT_DEALERS.forall(d => is_dealer_distributing(dealer_state.get(d))))
            .expect(sent_pub_msgs.size() == 6)
            .expect(sent_priv_msgs.size() == 42)

            .then(player_start("p0"))
            .then(player_start("p1"))
            .then(player_start("p2"))
            .then(player_start("p3"))
            .then(player_start("p4"))
            .then(player_start("p5"))
            .expect(CORRECT_PLAYERS.forall(p => is_player_receiving(player_state.get(p))))

            .then(player_receives_share("p0", "p0", poly0))
            .then(player_receives_share("p0", "p1", poly1))
            .then(player_receives_share("p0", "p2", poly2))
            .then(player_receives_share("p0", "p3", poly3))
            .then(player_receives_share("p0", "p4", poly4))
            .then(player_receives_share("p0", "p6", poly6))
            .then(player_receives_share("p1", "p0", poly0))
            .then(player_receives_share("p1", "p1", poly1))
            .then(player_receives_share("p1", "p2", poly2))
            .then(player_receives_share("p1", "p3", poly3))
            .then(player_receives_share("p1", "p4", poly4))
            .then(player_receives_share("p1", "p6", poly6))
            .then(player_receives_share("p2", "p0", poly0))
            .then(player_receives_share("p2", "p1", poly1))
            .then(player_receives_share("p2", "p2", poly2))
            .then(player_receives_share("p2", "p3", poly3))
            .then(player_receives_share("p2", "p4", poly4))
            .then(player_receives_share("p2", "p6", poly6))
            .then(player_receives_share("p3", "p0", poly0))
            .then(player_receives_share("p3", "p1", poly1))
            .then(player_receives_share("p3", "p2", poly2))
            .then(player_receives_share("p3", "p3", poly3))
            .then(player_receives_share("p3", "p4", poly4))
            .then(player_receives_share("p3", "p6", poly6))
            .then(player_receives_share("p4", "p0", poly0))
            .then(player_receives_share("p4", "p1", poly1))
            .then(player_receives_share("p4", "p2", poly2))
            .then(player_receives_share("p4", "p3", poly3))
            .then(player_receives_share("p4", "p4", poly4))
            .then(player_receives_share("p4", "p6", poly6))
            .then(player_receives_share("p5", "p0", poly0))
            .then(player_receives_share("p5", "p1", poly1))
            .then(player_receives_share("p5", "p2", poly2))
            .then(player_receives_share("p5", "p3", poly3))
            .then(player_receives_share("p5", "p4", poly4))
            .then(player_receives_share("p5", "p6", poly6))
            .expect(sent_acks.size() == 36)

            .then(dealer_receives_ack("p0", "p0"))
            .then(dealer_receives_ack("p0", "p1"))
            .then(dealer_receives_ack("p0", "p2"))
            .then(dealer_receives_ack("p0", "p3"))
            .then(dealer_receives_ack("p0", "p4"))
            .then(dealer_receives_ack("p0", "p5"))
            .then(dealer_receives_ack("p1", "p0"))
            .then(dealer_receives_ack("p1", "p1"))
            .then(dealer_receives_ack("p1", "p2"))
            .then(dealer_receives_ack("p1", "p3"))
            .then(dealer_receives_ack("p1", "p4"))
            .then(dealer_receives_ack("p1", "p5"))
            .then(dealer_receives_ack("p2", "p0"))
            .then(dealer_receives_ack("p2", "p1"))
            .then(dealer_receives_ack("p2", "p2"))
            .then(dealer_receives_ack("p2", "p3"))
            .then(dealer_receives_ack("p2", "p4"))
            .then(dealer_receives_ack("p2", "p5"))
            .then(dealer_receives_ack("p3", "p0"))
            .then(dealer_receives_ack("p3", "p1"))
            .then(dealer_receives_ack("p3", "p2"))
            .then(dealer_receives_ack("p3", "p3"))
            .then(dealer_receives_ack("p3", "p4"))
            .then(dealer_receives_ack("p3", "p5"))
            .then(dealer_receives_ack("p4", "p0"))
            .then(dealer_receives_ack("p4", "p1"))
            .then(dealer_receives_ack("p4", "p2"))
            .then(dealer_receives_ack("p4", "p3"))
            .then(dealer_receives_ack("p4", "p4"))
            .then(dealer_receives_ack("p4", "p5"))
            .then(dealer_receives_ack("p6", "p0"))
            .then(dealer_receives_ack("p6", "p1"))
            .then(dealer_receives_ack("p6", "p2"))
            .then(dealer_receives_ack("p6", "p3"))
            .then(dealer_receives_ack("p6", "p4"))
            .then(dealer_receives_ack("p6", "p5"))
            .expect(get_distributing(dealer_state.get("p0")).acks_received.size() == 6)
            .expect(get_distributing(dealer_state.get("p1")).acks_received.size() == 6)

            .then(dealer_finalizes("p0"))
            .then(dealer_finalizes("p1"))
            .then(dealer_finalizes("p2"))
            .then(dealer_finalizes("p3"))
            .then(dealer_finalizes("p4"))
            .then(dealer_finalizes("p6"))
            .expect(CORRECT_DEALERS.forall(d => is_dealer_finalized(dealer_state.get(d))))
            .expect(sent_logs.size() == 6)
            .expect(sent_logs.forall(entry => match entry.log.result {
                | DealerOk(results) =>
                    match results.get("p6") { | Reveal(_) => true | Ack(_) => false } and
                    CORRECT_PLAYERS.forall(p =>
                        match results.get(p) { | Ack(_) => true | Reveal(_) => false }
                    )
                | TooManyReveals => false
            }))

            .then(player_finalize("p0"))
            .expect(is_player_finalized(player_state.get("p0")))
            .expect(ghost_selected_dealers.size() == 6)

            .then(player_finalize("p1"))
            .then(player_finalize("p2"))
            .then(player_finalize("p3"))
            .then(player_finalize("p4"))
            .then(player_finalize("p5"))
            .expect(CORRECT_PLAYERS.forall(p => is_player_finalized(player_state.get(p))))
            .expect(safe)
            .expect(share_secrecy)
    }

    // Byzantine dealer p5 sends fake log - gets rejected
    run byzantineDealerRejectedN7Test = {
        val poly0 = List(1, 2, 3, 4, 5)
        val poly1 = List(6, 7, 8, 9, 10)
        val poly2 = List(11, 12, 13, 14, 15)
        val poly3 = List(1, 2, 3, 4, 5)
        val poly4 = List(6, 7, 8, 9, 10)
        val poly6 = List(11, 12, 13, 14, 15)

        init
            .then(dealer_start("p0", poly0))
            .then(dealer_start("p1", poly1))
            .then(dealer_start("p2", poly2))
            .then(dealer_start("p3", poly3))
            .then(dealer_start("p4", poly4))
            .then(dealer_start("p6", poly6))

            .then(player_start("p0"))
            .then(player_start("p1"))
            .then(player_start("p2"))
            .then(player_start("p3"))
            .then(player_start("p4"))
            .then(player_start("p5"))

            .then(player_receives_share("p0", "p0", poly0))
            .then(player_receives_share("p0", "p1", poly1))
            .then(player_receives_share("p0", "p2", poly2))
            .then(player_receives_share("p0", "p3", poly3))
            .then(player_receives_share("p0", "p4", poly4))
            .then(player_receives_share("p0", "p6", poly6))
            .then(player_receives_share("p1", "p0", poly0))
            .then(player_receives_share("p1", "p1", poly1))
            .then(player_receives_share("p1", "p2", poly2))
            .then(player_receives_share("p1", "p3", poly3))
            .then(player_receives_share("p1", "p4", poly4))
            .then(player_receives_share("p1", "p6", poly6))
            .then(player_receives_share("p2", "p0", poly0))
            .then(player_receives_share("p2", "p1", poly1))
            .then(player_receives_share("p2", "p2", poly2))
            .then(player_receives_share("p2", "p3", poly3))
            .then(player_receives_share("p2", "p4", poly4))
            .then(player_receives_share("p2", "p6", poly6))
            .then(player_receives_share("p3", "p0", poly0))
            .then(player_receives_share("p3", "p1", poly1))
            .then(player_receives_share("p3", "p2", poly2))
            .then(player_receives_share("p3", "p3", poly3))
            .then(player_receives_share("p3", "p4", poly4))
            .then(player_receives_share("p3", "p6", poly6))
            .then(player_receives_share("p4", "p0", poly0))
            .then(player_receives_share("p4", "p1", poly1))
            .then(player_receives_share("p4", "p2", poly2))
            .then(player_receives_share("p4", "p3", poly3))
            .then(player_receives_share("p4", "p4", poly4))
            .then(player_receives_share("p4", "p6", poly6))
            .then(player_receives_share("p5", "p0", poly0))
            .then(player_receives_share("p5", "p1", poly1))
            .then(player_receives_share("p5", "p2", poly2))
            .then(player_receives_share("p5", "p3", poly3))
            .then(player_receives_share("p5", "p4", poly4))
            .then(player_receives_share("p5", "p6", poly6))

            .then(dealer_receives_ack("p0", "p0"))
            .then(dealer_receives_ack("p0", "p1"))
            .then(dealer_receives_ack("p0", "p2"))
            .then(dealer_receives_ack("p0", "p3"))
            .then(dealer_receives_ack("p0", "p4"))
            .then(dealer_receives_ack("p0", "p5"))
            .then(dealer_receives_ack("p1", "p0"))
            .then(dealer_receives_ack("p1", "p1"))
            .then(dealer_receives_ack("p1", "p2"))
            .then(dealer_receives_ack("p1", "p3"))
            .then(dealer_receives_ack("p1", "p4"))
            .then(dealer_receives_ack("p1", "p5"))
            .then(dealer_receives_ack("p2", "p0"))
            .then(dealer_receives_ack("p2", "p1"))
            .then(dealer_receives_ack("p2", "p2"))
            .then(dealer_receives_ack("p2", "p3"))
            .then(dealer_receives_ack("p2", "p4"))
            .then(dealer_receives_ack("p2", "p5"))
            .then(dealer_receives_ack("p3", "p0"))
            .then(dealer_receives_ack("p3", "p1"))
            .then(dealer_receives_ack("p3", "p2"))
            .then(dealer_receives_ack("p3", "p3"))
            .then(dealer_receives_ack("p3", "p4"))
            .then(dealer_receives_ack("p3", "p5"))
            .then(dealer_receives_ack("p4", "p0"))
            .then(dealer_receives_ack("p4", "p1"))
            .then(dealer_receives_ack("p4", "p2"))
            .then(dealer_receives_ack("p4", "p3"))
            .then(dealer_receives_ack("p4", "p4"))
            .then(dealer_receives_ack("p4", "p5"))
            .then(dealer_receives_ack("p6", "p0"))
            .then(dealer_receives_ack("p6", "p1"))
            .then(dealer_receives_ack("p6", "p2"))
            .then(dealer_receives_ack("p6", "p3"))
            .then(dealer_receives_ack("p6", "p4"))
            .then(dealer_receives_ack("p6", "p5"))
            .then(dealer_finalizes("p0"))
            .then(dealer_finalizes("p1"))
            .then(dealer_finalizes("p2"))
            .then(dealer_finalizes("p3"))
            .then(dealer_finalizes("p4"))
            .then(dealer_finalizes("p6"))

            .then(byzantine_send_log("p5", {
                pub_msg: { commitment: List(1, 1, 1, 1, 1) },
                result: DealerOk(PLAYERS.mapBy(p => Ack({ player: p, dealer: "p5" })))
            }))
            .expect(sent_logs.size() == 7)
            .expect(not(is_consistent_log("p5", sent_logs.filter(e => e.dealer == "p5").fold(
                { pub_msg: { commitment: List() }, result: TooManyReveals },
                (_, e) => e.log
            ))))

            .then(player_finalize("p0"))
            .expect(ghost_selected_dealers == Set("p0", "p1", "p2", "p3", "p4", "p6"))
            .expect(safe)
    }

    // Output agreement: all correct players compute same public polynomial
    run outputAgreementN7Test = {
        val poly0 = List(1, 2, 3, 4, 5)
        val poly1 = List(6, 7, 8, 9, 10)
        val poly2 = List(11, 12, 13, 14, 15)
        val poly3 = List(1, 2, 3, 4, 5)
        val poly4 = List(6, 7, 8, 9, 10)
        val poly6 = List(11, 12, 13, 14, 15)
        val expected_combined = add_poly(add_poly(add_poly(add_poly(add_poly(
            poly0, poly1), poly2), poly3), poly4), poly6)

        init
            .then(dealer_start("p0", poly0))
            .then(dealer_start("p1", poly1))
            .then(dealer_start("p2", poly2))
            .then(dealer_start("p3", poly3))
            .then(dealer_start("p4", poly4))
            .then(dealer_start("p6", poly6))
            .then(player_start("p0"))
            .then(player_start("p1"))
            .then(player_start("p2"))
            .then(player_start("p3"))
            .then(player_start("p4"))
            .then(player_start("p5"))

            .then(player_receives_share("p0", "p0", poly0))
            .then(player_receives_share("p0", "p1", poly1))
            .then(player_receives_share("p0", "p2", poly2))
            .then(player_receives_share("p0", "p3", poly3))
            .then(player_receives_share("p0", "p4", poly4))
            .then(player_receives_share("p0", "p6", poly6))
            .then(player_receives_share("p1", "p0", poly0))
            .then(player_receives_share("p1", "p1", poly1))
            .then(player_receives_share("p1", "p2", poly2))
            .then(player_receives_share("p1", "p3", poly3))
            .then(player_receives_share("p1", "p4", poly4))
            .then(player_receives_share("p1", "p6", poly6))
            .then(player_receives_share("p2", "p0", poly0))
            .then(player_receives_share("p2", "p1", poly1))
            .then(player_receives_share("p2", "p2", poly2))
            .then(player_receives_share("p2", "p3", poly3))
            .then(player_receives_share("p2", "p4", poly4))
            .then(player_receives_share("p2", "p6", poly6))
            .then(player_receives_share("p3", "p0", poly0))
            .then(player_receives_share("p3", "p1", poly1))
            .then(player_receives_share("p3", "p2", poly2))
            .then(player_receives_share("p3", "p3", poly3))
            .then(player_receives_share("p3", "p4", poly4))
            .then(player_receives_share("p3", "p6", poly6))
            .then(player_receives_share("p4", "p0", poly0))
            .then(player_receives_share("p4", "p1", poly1))
            .then(player_receives_share("p4", "p2", poly2))
            .then(player_receives_share("p4", "p3", poly3))
            .then(player_receives_share("p4", "p4", poly4))
            .then(player_receives_share("p4", "p6", poly6))
            .then(player_receives_share("p5", "p0", poly0))
            .then(player_receives_share("p5", "p1", poly1))
            .then(player_receives_share("p5", "p2", poly2))
            .then(player_receives_share("p5", "p3", poly3))
            .then(player_receives_share("p5", "p4", poly4))
            .then(player_receives_share("p5", "p6", poly6))

            .then(dealer_receives_ack("p0", "p0"))
            .then(dealer_receives_ack("p0", "p1"))
            .then(dealer_receives_ack("p0", "p2"))
            .then(dealer_receives_ack("p0", "p3"))
            .then(dealer_receives_ack("p0", "p4"))
            .then(dealer_receives_ack("p0", "p5"))
            .then(dealer_receives_ack("p1", "p0"))
            .then(dealer_receives_ack("p1", "p1"))
            .then(dealer_receives_ack("p1", "p2"))
            .then(dealer_receives_ack("p1", "p3"))
            .then(dealer_receives_ack("p1", "p4"))
            .then(dealer_receives_ack("p1", "p5"))
            .then(dealer_receives_ack("p2", "p0"))
            .then(dealer_receives_ack("p2", "p1"))
            .then(dealer_receives_ack("p2", "p2"))
            .then(dealer_receives_ack("p2", "p3"))
            .then(dealer_receives_ack("p2", "p4"))
            .then(dealer_receives_ack("p2", "p5"))
            .then(dealer_receives_ack("p3", "p0"))
            .then(dealer_receives_ack("p3", "p1"))
            .then(dealer_receives_ack("p3", "p2"))
            .then(dealer_receives_ack("p3", "p3"))
            .then(dealer_receives_ack("p3", "p4"))
            .then(dealer_receives_ack("p3", "p5"))
            .then(dealer_receives_ack("p4", "p0"))
            .then(dealer_receives_ack("p4", "p1"))
            .then(dealer_receives_ack("p4", "p2"))
            .then(dealer_receives_ack("p4", "p3"))
            .then(dealer_receives_ack("p4", "p4"))
            .then(dealer_receives_ack("p4", "p5"))
            .then(dealer_receives_ack("p6", "p0"))
            .then(dealer_receives_ack("p6", "p1"))
            .then(dealer_receives_ack("p6", "p2"))
            .then(dealer_receives_ack("p6", "p3"))
            .then(dealer_receives_ack("p6", "p4"))
            .then(dealer_receives_ack("p6", "p5"))
            .then(dealer_finalizes("p0"))
            .then(dealer_finalizes("p1"))
            .then(dealer_finalizes("p2"))
            .then(dealer_finalizes("p3"))
            .then(dealer_finalizes("p4"))
            .then(dealer_finalizes("p6"))

            .then(player_finalize("p0"))
            .then(player_finalize("p1"))
            .then(player_finalize("p2"))
            .then(player_finalize("p3"))
            .then(player_finalize("p4"))
            .then(player_finalize("p5"))

            .expect(ghost_public_polys.get("p0") == expected_combined)
            .expect(ghost_public_polys.get("p1") == expected_combined)
            .expect(ghost_public_polys.get("p2") == expected_combined)
            .expect(ghost_public_polys.get("p3") == expected_combined)
            .expect(ghost_public_polys.get("p4") == expected_combined)
            .expect(ghost_public_polys.get("p5") == expected_combined)
            .expect(output_agreement)
    }
}
