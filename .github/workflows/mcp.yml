name: MCP

on:
  push:
    branches: ["main"]
  pull_request:
  merge_group:

permissions:
  contents: read

concurrency:
  group: mcp-${{ github.head_ref || github.ref_name || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

defaults:
  run:
    working-directory: mcp

jobs:
  Lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: mcp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

  Build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: mcp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  Test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: mcp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  Integration:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: mcp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run D1 migrations (local)
        run: npx wrangler d1 migrations apply commonware-mcp-search --local

      - name: Start wrangler dev server
        run: |
          npx wrangler dev --local --port 8787 &
          echo $! > /tmp/wrangler.pid
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:8787/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done

      - name: Test health endpoint
        run: |
          response=$(curl -s http://localhost:8787/health)
          echo "Health response: $response"
          if ! echo "$response" | grep -q '"status":"ok"'; then
            echo "ERROR: Health check failed"
            exit 1
          fi
          echo "✓ Health check passed"

      - name: Test MCP server responds
        run: |
          # Test that the MCP endpoint accepts connections (SSE)
          response=$(curl -s -X POST http://localhost:8787 \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0.0"}}}' \
            --max-time 5 || true)
          echo "MCP response: $response"
          # Just verify we get a valid JSON-RPC response (not an error page)
          if echo "$response" | grep -q '"jsonrpc"'; then
            echo "✓ MCP server responded with JSON-RPC"
          else
            echo "Note: MCP may use SSE transport, checking if server is accepting connections..."
            # For SSE, just verify the endpoint doesn't 404
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8787)
            if [ "$status" = "404" ]; then
              echo "ERROR: MCP endpoint returned 404"
              exit 1
            fi
            echo "✓ MCP endpoint is accessible (HTTP $status)"
          fi

      - name: Trigger indexing and test search
        run: |
          # Trigger the scheduled handler to index real data from commonware.xyz
          echo "Triggering scheduled indexing..."
          curl -s "http://localhost:8787/__scheduled?cron=0+*+*+*+*" || true

          # Wait for indexing to complete (check for indexed versions)
          echo "Waiting for indexing to complete..."
          for i in {1..60}; do
            result=$(npx wrangler d1 execute commonware-mcp-search --local --command "SELECT COUNT(*) as count FROM indexed_versions;" --json 2>/dev/null)
            count=$(echo "$result" | grep -o '"count":[0-9]*' | grep -o '[0-9]*' || echo "0")
            if [ "$count" -gt "0" ]; then
              echo "✓ Indexing complete - $count version(s) indexed"
              break
            fi
            echo "Waiting for indexing... ($i/60)"
            sleep 2
          done

          # Verify files were indexed
          result=$(npx wrangler d1 execute commonware-mcp-search --local --command "SELECT COUNT(*) as count FROM files;" --json)
          echo "Files indexed: $result"

          # Test FTS search for a common word
          result=$(npx wrangler d1 execute commonware-mcp-search --local --command "SELECT path FROM files_fts WHERE files_fts MATCH 'impl' LIMIT 5;" --json)
          echo "FTS search for 'impl': $result"

          if echo "$result" | grep -q "\.rs"; then
            echo "✓ FTS search found Rust files containing 'impl'"
          else
            echo "ERROR: FTS search did not find expected results"
            exit 1
          fi

          # Test prefix matching
          result=$(npx wrangler d1 execute commonware-mcp-search --local --command "SELECT path FROM files_fts WHERE files_fts MATCH '\"public\"*' LIMIT 5;" --json)
          echo "FTS prefix search for 'public*': $result"

          if echo "$result" | grep -q "path"; then
            echo "✓ FTS prefix search works"
          else
            echo "Note: No results for 'public*' prefix search (may be expected)"
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/wrangler.pid ]; then
            kill $(cat /tmp/wrangler.pid) 2>/dev/null || true
          fi

  Lock:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: mcp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check package-lock.json unchanged
        run: |
          if ! git diff --exit-code package-lock.json; then
            echo "ERROR: package-lock.json was modified during install!"
            echo "This suggests that the package-lock.json file in the repository is not up to date."
            echo "Please run 'npm install' locally and commit the updated package-lock.json."
            exit 1
          fi
          echo "✓ package-lock.json remained unchanged after npm ci"
