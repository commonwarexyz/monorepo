digraph revm_architecture {
  rankdir=TB;
  splines=true;
  nodesep=0.4;
  ranksep=0.6;
  fontname="Helvetica";
  fontsize=12;

  node [
    shape=box,
    style="rounded,filled",
    fillcolor="white",
    color="#666666",
    fontname="Helvetica",
    fontsize=10
  ];
  edge [
    color="#555555",
    fontname="Helvetica",
    fontsize=9,
    arrowsize=0.7
  ];

  subgraph cluster_sim {
    label="Simulation / Scenario";
    style="rounded,filled";
    color="#C9E3F8";
    fillcolor="#EDF6FF";

    CLI[label="CLI\nsimulate(...)"];
    Demo[label="Demo scenario\n(genesis + one tx)"];
    SimHarness[label="Simulation harness"];
    SimNet[label="Simulated P2P\nnetwork"];

    CLI -> SimHarness;
    Demo -> SimHarness;
    SimHarness -> SimNet;
  }

  subgraph cluster_node {
    label="Node (single participant)";
    style="rounded,filled";
    color="#D9D9D9";
    fillcolor="#F7F7F7";

    subgraph cluster_consensus {
      label="Consensus context";
      style="rounded,filled";
      color="#F3E6B3";
      fillcolor="#FFF8E1";

      Simplex[label="Threshold Simplex\norders digests"];
      Marshal[label="Marshal\nbroadcast + backfill"];
      P2P[label="Transport channels"];

      P2P -> Simplex [label="votes, certs, resolver"];
      P2P -> Marshal [label="blocks, backfill"];
    }

    subgraph cluster_app {
      label="Application context";
      style="rounded,filled";
      color="#BFE6D0";
      fillcolor="#E9FFF4";

      App[label="RevmApplication\npropose + verify"];
      Ledger[label="LedgerService\nmempool + snapshots + seeds"];
      Exec[label="execute_txs\n(REVM)"];
      SeedRep[label="SeedReporter"];
      FinalRep[label="FinalizedReporter"];
    }

    subgraph cluster_storage {
      label="Storage";
      style="rounded,filled";
      color="#F3C4C4";
      fillcolor="#FFF0F0";

      QMDB[label="QMDB\naccounts / storage / code"];
    }
  }

  SimNet -> P2P [label="connect peers"];
  SimHarness -> App [label="start node"];

  Simplex -> App [label="propose/verify"];
  App -> Simplex [label="block digest"];
  App -> Marshal [label="full blocks"];
  Marshal -> App [label="backfill ancestors"];

  Simplex -> SeedRep [label="seed signatures"];
  Marshal -> FinalRep [label="finalized blocks"];
  SeedRep -> Ledger [label="store seed hash"];
  FinalRep -> Ledger [label="persist snapshot"];

  App -> Ledger [label="build txs, snapshots"];
  Ledger -> Exec [label="parent snapshot"];
  Exec -> Ledger [label="state changes"];
  Ledger -> QMDB [label="commit changes / preview root"];
  QMDB -> Ledger [label="read root, balances"];
}
